---
title: "Data Manipulation with R"
author: "Richard Vogg"
date: "January 21$^{st}$, 2019"
output:
  ioslides_presentation:  
    widescreen: true
  slidy_presentation: default
  beamer_presentation: default
subtitle: using `dplyr` and `%>%` (the pipe)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## 30 Minutes: What are we going to learn?

- Data manipulation made easy (The 5 functions of `dplyr`)
- Creating readable code using the pipe `%>%`
- Application on a dataset on earthquakes in Chile
- Hands-on: Try directly out what you learn

## The dataset

```{r dataset2,echo=TRUE,eval=FALSE}
data <- read.csv("Earthquakes Chile.csv",stringsAsFactors = F,skip=9)
head(data)
```

```{r dataset,echo=FALSE}
data <- read.csv("E:/Users/Richard.Vogg/Documents/R_docs/LINK2019/Earthquakes Chile.csv",stringsAsFactors = F,skip=9)
knitr::kable(data[1:4,c(1:5,14)])
```

## The 5 functions of `dplyr`

- data manipulation package by Hadley Wickham
- provides simple functions helping with most common data manipulation tasks
- very intuitive use
- common syntax: first argument for each function is a dataframe, output is a new dataframe
- Installation of the package

```{r install,echo=TRUE, warning=FALSE,eval=FALSE}
install.packages("dplyr")
```

- Working with the package

```{r lib,echo=TRUE,eval=TRUE, warning=FALSE,message=FALSE}
library(dplyr)
```


## 1 - `select`

```{r select,echo=TRUE,eval=FALSE}
select(data,place,mag)
```

```{r select2,echo=FALSE,warning=FALSE,eval=TRUE}
data %>% select(place,mag) %>% data.frame() %>% {print(.[1:8,])}# {knitr::kable(.[1:4,])}
```

## 2 - `filter`

```{r filter,echo=TRUE,eval=FALSE}
filter(data,mag>7.6)
```

```{r filter2,echo=FALSE,warning=FALSE,eval=TRUE,message=FALSE}
data %>% filter(mag>7.6) %>% data.frame() %>% {print(.[,c(1,2,5,14)])} 
```

## 3 - `arrange`

```{r arrange,echo=TRUE,eval=FALSE}
arrange(data,desc(mag))
```

```{r arrange2,echo=FALSE,warning=FALSE,eval=TRUE,message=FALSE}
data %>% arrange(desc(mag)) %>%data.frame() %>% {print(.[1:8,c(1,2,5,14)])}# %>% {knitr::kable(.[1:4,c(1:3,5,14)])}
```

## 4 - `mutate`

```{r mutate,echo=TRUE,eval=FALSE}
data <- mutate(data,year=substr(time,1,4))
```

```{r mutate2,echo=FALSE,warning=FALSE,eval=TRUE,message=FALSE}
data %>% mutate(year=substr(time,1,4)) %>% data.frame() %>% {print(.[1:5,c(1,5,14,ncol(.))])} #%>% {knitr::kable(.[1:4,c(1,5,14,ncol(.))])}
```



## 5 - `group_by` / `summarize`

```{r groupby,echo=TRUE,eval=FALSE}
summarize(group_by(data,year),number_earthquakes=n())
```

```{r groupby2,echo=FALSE,warning=FALSE,eval=TRUE,message=FALSE}
data %>% mutate(year=substr(time,1,4)) %>% group_by(year) %>% summarize(number_earthquakes=n()) %>% data.frame() %>% {print(.[5:17,])}# %>% {knitr::kable(.[9:13,]}
```

##Readability

Example: Find the square-root of each element in a vector, round it to two digits and find the maximum among these elements.

```{r example,warning=FALSE,message=FALSE,echo=TRUE}
a <- c(1,2,5,6,3,4)

max(round(sqrt(a),2))

a %>% sqrt() %>% round(2) %>% max()
```

## The pipe `%>%`

- Origin: package "magrittr" by Stefan Milton Bache
- Aim: Make code more readable, maintainable, easier to debug
- Basic piping:
    - `x %>% f` is equivalent to `f(x)`
    - `x %>% f(y)` is equivalent to `f(x, y)`
    - `x %>% f %>% g %>% h` is equivalent to `h(g(f(x)))`



## Extract the country from the place

```{r b,echo=TRUE,eval=FALSE}
data$place
```

```{r b1,echo=FALSE,eval=TRUE}
data$place[1:5]
```

or

```{r b2,echo=TRUE,eval=FALSE}
data %>% select(place)
```


```{r b3,echo=FALSE,eval=TRUE}
data %>% select(place) %>% {print(.[1:5,])}
```

## Split the string

```{r c,echo=TRUE}
data$place %>%
  strsplit(split=", ")
```

## Get the country name

```{r d,echo=TRUE}
data$place %>%
  strsplit(split=", ") %>%
  lapply(function(x) x <- x[2])
```

## Convert the list to a vector

```{r e, echo = TRUE}
data$place %>%
  strsplit(split=", ") %>% 
  lapply(function(x) x <- x[2]) %>%
  unlist()
```


## Combining everything: Top 10 regions with most earthquakes?

```{r pressure2,echo=FALSE,eval=TRUE}
data %>%
  select(mag,place) %>%
  mutate(country=place %>% strsplit(split=", ") %>% 
           lapply(function(x) x <- x[2]) %>%
           unlist()
        ) %>%
  filter(country=="Chile") %>%
  mutate(region=place %>% strsplit(split=" of |, ") %>% 
           lapply(function(x) x <- x[length(x)-1]) %>%
           unlist()
        ) %>%
  group_by(region) %>%
  summarize(number_earthquakes=n(),strongest=max(mag)) %>%
  arrange(desc(number_earthquakes)) %>%
  data.frame() %>%
  top_n(10,number_earthquakes)
```

## Combining everything

```{r pressure,echo=TRUE,eval=FALSE}
data %>%
  select(mag,place) %>%
  mutate(country=place %>% strsplit(split=", ") %>% 
           lapply(function(x) x <- x[2]) %>% unlist()) %>%
  filter(country=="Chile") %>%
  mutate(region=place %>% strsplit(split=" of |, ") %>% 
           lapply(function(x) x <- x[length(x)-1]) %>% unlist()) %>%
  group_by(region) %>%
  summarise(number_earthquakes=n(),strongest=max(mag)) %>%
  arrange(desc(number_earthquakes)) %>%
  data.frame() %>%
  top_n(10,number_earthquakes)
```

Task: List the 10 strongest earthquakes happening in and around Valparaiso 
(Bonus: Display the year of these events).

## Solution

Strongest earthquakes in Valparaiso

```{r sol2,echo=TRUE,eval=TRUE}
data %>%
  select(mag,place) %>%
  mutate(country=place %>% strsplit(split=", ") %>% 
           lapply(function(x) x <- x[2]) %>% unlist()) %>%
  filter(country=="Chile") %>%
  mutate(region=place %>% strsplit(split=" of |, ") %>% 
           lapply(function(x) x <- x[length(x)-1]) %>% unlist()) %>%
  filter(region=="Valparaiso") %>%
  arrange(desc(mag)) %>%
  data.frame() %>%
  top_n(10,mag)
```


## Solution

Strongest earthquakes in Valparaiso with year

```{r sol3,echo=TRUE,eval=TRUE}
data %>%
  select(mag,place,time) %>%
  mutate(year=substr(time,1,4)) %>%
  select(-time) %>%
  mutate(country=place %>% strsplit(split=", ") %>% 
           lapply(function(x) x <- x[2]) %>% unlist()) %>%
  filter(country=="Chile") %>%
  mutate(region=place %>% strsplit(split=" of |, ") %>% 
           lapply(function(x) x <- x[length(x)-1]) %>% unlist()) %>%
  filter(region=="Valparaiso") %>%
  arrange(desc(mag)) %>%
  data.frame() %>%
  top_n(10,mag)
```

## Want to know more?

- The pipe `%>%`
    - https://github.com/tidyverse/magrittr
    - type `install.packages("magrittr")` and then `browseVignettes("magrittr")` in your RStudio console 
- Data manipulation with `dplyr`
    - https://github.com/tidyverse/dplyr
    - type `install.packages("dplyr")` and then `browseVignettes("dplyr")` in your RStudio console
- Earthquake data
    - https://earthquake.usgs.gov/earthquakes/search/